___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "categories": [
    "CONVERSION_TRACKING",
    "PERSONALIZATION"
  ],
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Stileo Tracking Pixel",
  "brand": {
    "displayName": "Stileo",
    "thumbnail": "data:image/png;base64,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\u003d\u003d",
    "id": "brand_custom_template"
  },
  "description": "",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "apiKey",
    "displayName": "API key",
    "simpleValueType": true,
    "help": "Please provide your API Key here. Reach out to your Account Manager in case you do not have it yet."
  },
  {
    "type": "TEXT",
    "name": "currency",
    "displayName": "Currency",
    "simpleValueType": true,
    "help": "Please provide currency code (ISO 4217). Please note that for now, EUR is the only currency supported."
  },
  {
    "type": "SELECT",
    "name": "eventType",
    "displayName": "Event Type",
    "macrosInSelect": false,
    "selectItems": [
      {
        "value": "PageView",
        "displayValue": "PageView"
      },
      {
        "value": "Purchase",
        "displayValue": "Purchase"
      },
      {
        "value": "ViewContent",
        "displayValue": "ViewContent"
      },
      {
        "value": "AddToCart",
        "displayValue": "AddToCart"
      },
      {
        "value": "GoToCheckout",
        "displayValue": "GoToCheckout"
      },
      {
        "value": "ProductFavourite",
        "displayValue": "ProductFavourite"
      },
      {
        "value": "ProductSearch",
        "displayValue": "ProductSearch"
      }
    ],
    "simpleValueType": true,
    "notSetText": "Select event type...",
    "help": "Please select event for which you will be setting up tag now. Depending on selected event type, you may need to provide different information."
  },
  {
    "type": "GROUP",
    "name": "purchase",
    "displayName": "Purchase Event",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "GROUP",
        "name": "orderIdSection",
        "displayName": "OrderID",
        "groupStyle": "ZIPPY_CLOSED",
        "subParams": [
          {
            "type": "RADIO",
            "name": "purchaseOrderIdOption",
            "displayName": "Please specify preferred way of parsing your orderID information. In case you use Enhanced Ecommerce this would be recommended mean of integration. Otherwise select relevant GTM Variable.",
            "radioItems": [
              {
                "value": "purchaseOrderIdOptionEedl",
                "displayValue": "Enhanced Ecommerce Data Layer"
              },
              {
                "value": "purchaseOrderIdOptionGtm",
                "displayValue": "GTM Variable",
                "subParams": [
                  {
                    "type": "TEXT",
                    "name": "purchaseOrderId",
                    "displayName": "",
                    "macrosInSelect": true,
                    "selectItems": [],
                    "simpleValueType": true
                  }
                ]
              }
            ],
            "simpleValueType": true,
            "subParams": [],
            "defaultValue": false
          }
        ],
        "help": "Please specify preferred way of parsing your orderID information. In case you use Enhanced Ecommerce this would be recommended mean of integration. Otherwise select relevant GTM Variable."
      },
      {
        "type": "GROUP",
        "name": "purchaseProductsSection",
        "displayName": "Products configuration",
        "groupStyle": "ZIPPY_CLOSED",
        "subParams": [
          {
            "type": "RADIO",
            "name": "purchaseProductsOption",
            "displayName": "Please specify preferred way of parsing your products information. In case you use Enhanced Ecommerce this would be recommended mean of integration. Otherwise select relevant GTM Variable.",
            "radioItems": [
              {
                "value": "purchaseProductsOptionEedl",
                "displayValue": "Enhanced Ecommerce Data Layer"
              },
              {
                "value": "purchaseProductsOptionGtm",
                "displayValue": "GTM Variable",
                "subParams": [
                  {
                    "type": "TEXT",
                    "name": "purchaseProducts",
                    "macrosInSelect": true,
                    "selectItems": [],
                    "simpleValueType": true
                  }
                ]
              }
            ],
            "simpleValueType": true,
            "defaultValue": false,
            "subParams": []
          }
        ],
        "help": "Please specify preferred way of parsing your products information. In case you use Enhanced Ecommerce this would be recommended mean of integration. Otherwise select relevant GTM Variable."
      }
    ],
    "enablingConditions": [
      {
        "paramName": "eventType",
        "paramValue": "Purchase",
        "type": "EQUALS"
      }
    ],
    "help": "Please specify preferred way of parsing your orderID information. In case you use Enhanced Ecommerce this would be recommended mean of integration. Otherwise select relevant GTM Variable."
  },
  {
    "type": "GROUP",
    "name": "addToCart",
    "displayName": "AddToCart Event",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "GROUP",
        "name": "addToCartProductsSection",
        "displayName": "Products configuration",
        "groupStyle": "ZIPPY_CLOSED",
        "subParams": [
          {
            "type": "RADIO",
            "name": "addToCartProductsOption",
            "displayName": "Please specify preferred way of parsing your products information. In case you use Enhanced Ecommerce this would be recommended mean of integration. Otherwise select relevant GTM Variable.",
            "radioItems": [
              {
                "value": "addToCartProductsOptionEedl",
                "displayValue": "Enhanced Ecommerce Data Layer"
              },
              {
                "value": "addToCartProductsOptionGtm",
                "displayValue": "GTM Variable",
                "subParams": [
                  {
                    "type": "TEXT",
                    "name": "addToCartProducts",
                    "displayName": "",
                    "macrosInSelect": true,
                    "selectItems": [],
                    "simpleValueType": true
                  }
                ]
              }
            ],
            "simpleValueType": true,
            "defaultValue": false
          }
        ],
        "help": "Please specify preferred way of parsing your products information. In case you use Enhanced Ecommerce this would be recommended mean of integration. Otherwise select relevant GTM Variable."
      }
    ],
    "enablingConditions": [
      {
        "paramName": "eventType",
        "paramValue": "AddToCart",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "productFavourite",
    "displayName": "ProductFavourite Event",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "GROUP",
        "name": "productFavouriteProductsSection",
        "displayName": "Products configuration",
        "groupStyle": "ZIPPY_CLOSED",
        "subParams": [
          {
            "type": "RADIO",
            "name": "productFavouriteProuctsOption",
            "displayName": "Please select relevant GTM variable",
            "radioItems": [
              {
                "value": "productFavouriteProductsOptionGtm",
                "displayValue": "GTM Variable",
                "subParams": [
                  {
                    "type": "TEXT",
                    "name": "productFavouriteProducts",
                    "displayName": "",
                    "macrosInSelect": true,
                    "selectItems": [],
                    "simpleValueType": true
                  }
                ]
              }
            ],
            "simpleValueType": true,
            "defaultValue": false
          }
        ]
      }
    ],
    "enablingConditions": [
      {
        "paramName": "eventType",
        "paramValue": "ProductFavourite",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "goToCheckout",
    "displayName": "GoToCheckout Event",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "GROUP",
        "name": "goToCheckoutProductsSection",
        "displayName": "Products configuration",
        "groupStyle": "ZIPPY_CLOSED",
        "subParams": [
          {
            "type": "RADIO",
            "name": "goToCheckoutProductsOption",
            "displayName": "Please specify preferred way of parsing your products information. In case you use Enhanced Ecommerce this would be recommended mean of integration. Otherwise select relevant GTM Variable.",
            "radioItems": [
              {
                "value": "goToCheckoutProductsOptionEedl",
                "displayValue": "Enhanced Ecommerce Data Layer"
              },
              {
                "value": "goToCheckoutProductsOptionGtm",
                "displayValue": "GTM Variable",
                "subParams": [
                  {
                    "type": "TEXT",
                    "name": "goToCheckoutProducts",
                    "displayName": "",
                    "macrosInSelect": true,
                    "selectItems": [],
                    "simpleValueType": true
                  }
                ]
              }
            ],
            "simpleValueType": true,
            "defaultValue": false
          }
        ]
      }
    ],
    "enablingConditions": [
      {
        "paramName": "eventType",
        "paramValue": "GoToCheckout",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "productSearch",
    "displayName": "ProductSearch Event",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "GROUP",
        "name": "searchQuerySection",
        "displayName": "Search Query",
        "groupStyle": "ZIPPY_CLOSED",
        "subParams": [
          {
            "type": "RADIO",
            "name": "searchQueryOption",
            "displayName": "Please select GTM variable capturing search query details",
            "radioItems": [
              {
                "value": "searchQueryOptionGtm",
                "displayValue": "GTM Variable",
                "subParams": [
                  {
                    "type": "TEXT",
                    "name": "searchQuery",
                    "displayName": "",
                    "macrosInSelect": true,
                    "selectItems": [],
                    "simpleValueType": true
                  }
                ]
              }
            ],
            "simpleValueType": true,
            "defaultValue": false
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "searchQueryCategoryPathSection",
        "displayName": "Category Path",
        "groupStyle": "ZIPPY_CLOSED",
        "subParams": [
          {
            "type": "RADIO",
            "name": "searchQueryCategoryPathOption",
            "displayName": "Please select GTM variable with information on the category path",
            "radioItems": [
              {
                "value": "searchQueryCategoryPathOptiongtm",
                "displayValue": "GTM Variable",
                "subParams": [
                  {
                    "type": "TEXT",
                    "name": "searchQueryCategoryPath",
                    "displayName": "",
                    "macrosInSelect": true,
                    "selectItems": [],
                    "simpleValueType": true
                  }
                ]
              }
            ],
            "simpleValueType": true,
            "defaultValue": false
          }
        ]
      }
    ],
    "enablingConditions": [
      {
        "paramName": "eventType",
        "paramValue": "ProductSearch",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "viewContent",
    "displayName": "ViewContent Event",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "SELECT",
        "name": "viewContentType",
        "displayName": "",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "product",
            "displayValue": "Product"
          },
          {
            "value": "productGroup",
            "displayValue": "ProductGroup"
          },
          {
            "value": "homePage",
            "displayValue": "HomePage"
          },
          {
            "value": "search",
            "displayValue": "Search"
          }
        ],
        "simpleValueType": true
      },
      {
        "type": "GROUP",
        "name": "viewContentProductsSection_product_productgroup",
        "displayName": "Products configuration",
        "groupStyle": "ZIPPY_CLOSED",
        "subParams": [
          {
            "type": "RADIO",
            "name": "viewContentProductsOption",
            "displayName": "Parse the product details from:",
            "radioItems": [
              {
                "value": "viewContentProductsEedl",
                "displayValue": "Enhanced Ecommerce Data Layer",
                "subParams": []
              },
              {
                "value": "viewContentProductsGtm",
                "displayValue": "GTM Variable",
                "subParams": [
                  {
                    "type": "TEXT",
                    "name": "viewContentProductsGtm",
                    "displayName": "",
                    "macrosInSelect": true,
                    "selectItems": [],
                    "simpleValueType": true
                  }
                ]
              }
            ],
            "simpleValueType": true,
            "defaultValue": false,
            "subParams": []
          }
        ],
        "enablingConditions": [
          {
            "paramName": "viewContentType",
            "paramValue": "product",
            "type": "EQUALS"
          },
          {
            "paramName": "viewContentType",
            "paramValue": "productGroup",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "viewContentProductsSection_hp_search",
        "displayName": "Products configuration",
        "groupStyle": "ZIPPY_CLOSED",
        "subParams": [
          {
            "type": "RADIO",
            "name": "viewContentProductsOption_hp_search",
            "displayName": "Parse the product details from:",
            "radioItems": [
              {
                "value": "viewContentProductsGtm_hp_search",
                "displayValue": "GTM Variable",
                "subParams": [
                  {
                    "type": "TEXT",
                    "name": "viewContentProducts",
                    "displayName": "",
                    "macrosInSelect": true,
                    "selectItems": [],
                    "simpleValueType": true
                  }
                ]
              }
            ],
            "simpleValueType": true,
            "defaultValue": false,
            "subParams": []
          }
        ],
        "enablingConditions": [
          {
            "paramName": "viewContentType",
            "paramValue": "homePage",
            "type": "EQUALS"
          },
          {
            "paramName": "viewContentType",
            "paramValue": "search",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "viewContentCategorySection_hp_search",
        "displayName": "Category Path",
        "groupStyle": "ZIPPY_CLOSED",
        "subParams": [
          {
            "type": "RADIO",
            "name": "viewContentCategoryPathOption_hp_search",
            "displayName": "Parse the orderID from...",
            "radioItems": [
              {
                "value": "viewContentCategoryPathGtm_hp_search",
                "displayValue": "GTM Variable",
                "subParams": [
                  {
                    "type": "TEXT",
                    "name": "viewContentCategoryPath",
                    "displayName": "",
                    "macrosInSelect": true,
                    "selectItems": [],
                    "simpleValueType": true
                  }
                ]
              }
            ],
            "simpleValueType": true,
            "subParams": [],
            "defaultValue": false
          }
        ],
        "enablingConditions": []
      }
    ],
    "enablingConditions": [
      {
        "paramName": "eventType",
        "paramValue": "ViewContent",
        "type": "EQUALS"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const injectScript = require('injectScript');
const callInWindow = require('callInWindow');
const log = require('logToConsole');
const set = require('setInWindow');
const JSON = require('JSON');
const createArgumentsQueue = require('createArgumentsQueue');
const readFromDataLayer = require('copyFromDataLayer');
const createQueue = require('createQueue');

let stileoObject = function(){
  createArgumentsQueue('stileo','stileoObject.queue');
};

set('stileo', stileoObject);
set('stileo.version', 2.1);
set('stileo.queue', []);

const onSuccess = function () {  
  
  
  let ecommerceDl = readFromDataLayer('ecommerce');
  
  var options = {
    preventPageView: true
  };
  
  if(data.eventType === 'PageView'){
    callInWindow('stileo','init', data.apiKey);
  }else{
    callInWindow('stileo','init', data.apiKey, options);
  }
  
  if(data.eventType === 'Purchase'){
    let eventObject = {
      OrderId: '',
      Currency: data.currency,
      Products: [],
    };
    
    if(data.purchaseOrderIdOption === 'purchaseOrderIdOptionEedl' && typeof ecommerceDl.purchase !== 'undefined'){
      eventObject.OrderId = ecommerceDl.purchase.actionField.id;
    }
    
    if(data.purchaseOrderIdOption === 'purchaseOrderIdOptionGtm'){
      eventObject.OrderId = data.purchaseOrderId;
    }
    
    if(data.purchaseProductsOption === 'purchaseProductsOptionEedl' && typeof ecommerceDl.purchase !== 'undefined'){
      ecommerceDl.purchase.products.forEach( product => {
        let pixelProduct = {
          Id: product.id,
          Price: product.price,
          Brand: product.brand,
          Name: product.name,
          Quantity: product.quantity
        };

        eventObject.Products.push(pixelProduct);
      });
      
    }
    
    if(data.purchaseProductsOption === 'purchaseProductsOptionGtm'){
      if(typeof data.purchaseProducts === 'string'){
        eventObject.Products = JSON.parse(data.purchaseProducts);
      }else{
        eventObject.Products = data.purchaseProducts;
      }  
    }
        
    callInWindow('stileo','track','Purchase', eventObject);
  }
  
  
  if(data.eventType === 'ViewContent'){
    
    let eventObject = {
      ContentType: data.viewContentType,
      Currency: data.currency,
      CategoryPath: data.viewContentCategoryPath,
      Products: [],
    };
    
    if(data.viewContentType === 'Product'){
      
      if(data.viewContentProductsOption === 'viewContentProductsOptionEedl' && typeof ecommerceDl.detail !== 'undefined'){
            
        ecommerceDl.detail.products.forEach( product => {
          let pixelProduct = {
            Id: product.id,
            Price: product.price,
            Brand: product.brand,
            Name: product.name,
          };

          eventObject.Products.push(pixelProduct);
        });   
      }
      
      if(data.viewContentProductsOption === 'viewContentProductsGtm'){
        if(typeof data.viewContentProductsGtm === 'string'){
          eventObject.Products = JSON.parse(data.viewContentProductsGtm);
        }else{
          eventObject.Products = data.viewContentProductsGtm;
        }
      }
    }else if(data.viewContentType === 'ProductsGroup'){
      
      if(data.viewContentProductsOption === 'viewContentProductsEedl' && typeof ecommerceDl.impressions !== 'undefined'){
            
        ecommerceDl.impressions.forEach( product => {
          let pixelProduct = {
            Id: product.id,
            Price: product.price,
            Brand: product.brand,
            Name: product.name,
          };

          eventObject.Products.push(pixelProduct);
        });   
      }
      
      if(data.viewContentProductsOption === 'viewContentProductsGtm'){
        if(typeof data.viewContentProductsGtm === 'string'){
          eventObject.Products = JSON.parse(data.viewContentProductsGtm);
        }else{
          eventObject.Products = data.viewContentProductsGtm;
        }
      }
      
    }else{
        if(typeof data.viewContentProductsGtm === 'string'){
          eventObject.Products = JSON.parse(data.viewContentProductsGtm);
        }else{
          eventObject.Products = data.viewContentProductsGtm;
        }
    }
    
    callInWindow('stileo','track','ViewContent', eventObject);
  }
  
  if(data.eventType === 'AddToCart'){
    
    let eventObject = {
      Currency: data.currency,
      Products: [],
    };
      
    if(data.addToCartProductsOption === 'addToCartProductsOptionEedl' && typeof ecommerceDl.add !== 'undefined'){
      ecommerceDl.add.products.forEach( product => {
        let pixelProduct = {
          Id: product.id,
          Price: product.price,
          Brand: product.brand,
          Name: product.name,
          Quantity: product.quantity,
          CategoryPath: product.category
        };

        eventObject.Products.push(pixelProduct);
      });
      
    }
    
    if(data.addToCartProductsOption === 'addToCartProductsOptionGtm'){
      if(typeof data.addToCartProducts === 'string'){
        eventObject.Products = JSON.parse(data.addToCartProducts);
      }else{
        eventObject.Products = data.addToCartProducts;
      }
    }
    
    callInWindow('stileo','track','AddToCart', eventObject);
  }
  
  if(data.eventType === 'ProductFavourite'){
    
    let eventObject = {
      Products: []
    };
    
    if(typeof data.productFavouriteProducts === 'string'){
      eventObject.Products = JSON.parse(data.productFavouriteProducts);
    }else{
      eventObject.Products = data.productFavouriteProducts;
    }
        
    callInWindow('stileo','track','ProductFavourite', eventObject);
  }
  
  if(data.eventType === 'GoToCheckout'){
    
    let eventObject = {
      Currency: data.currency,
      Products: [],
    };
        
    if(data.goToCheckoutProductsOption === 'goToCheckoutProductsOptionEedl' && typeof ecommerceDl.checkout !== 'undefined'){
      ecommerceDl.checkout.products.forEach( product => {
        let pixelProduct = {
          Id: product.id,
          Price: product.price,
          Brand: product.brand,
          Name: product.name,
          Quantity: product.quantity
        };

        eventObject.Products.push(pixelProduct);
      });
      
    }
    
    if(data.goToCheckoutProductsOption === 'goToCheckoutProductsOptionGtm'){
      if(typeof data.goToCheckoutProducts === 'string'){
        eventObject.Products = JSON.parse(data.goToCheckoutProducts);
      }else{
        eventObject.Products = data.goToCheckoutProducts;
      }
    }
            
    callInWindow('stileo','track','GoToCheckout', eventObject);
  }
  
  if(data.eventType === 'ProductSearch'){
    
    let eventObject = {
      SearchQuery: data.searchQuery,
      CategoryPath: data.searchQueryCategoryPath
    };
        
    callInWindow('stileo','track','ProductSearch', eventObject);
  }
  
  data.gtmOnSuccess();
};

const onFailure = function () {
  log('Loading script error'); 
  data.gtmOnFailure();
};

injectScript('https://tpx.stileo.it/tr.js', onSuccess, onFailure);


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "stileo"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "stileo.queue"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "stileo.version"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://tpx.stileo.it/tr.js"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keyPatterns",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "ecommerce.*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Untitled test 1
  code: |2-

    // Call runCode to run the template's code.
    runCode(mockData);

    // Verify that the tag finished successfully.
    assertApi('gtmOnSuccess').wasCalled();


___NOTES___

Created on 16/04/2021, 15:30:05


